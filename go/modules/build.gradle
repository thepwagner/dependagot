def goImage = 'dependagot-go-modules:latest'
def goDevImage = 'dependagot-go-modules-dev:latest'
def goDir = project(':go').projectDir

task build(type: Exec, dependsOn: ':go:common:protoc') {
  executable 'docker'
  args = ['build', '-t', goImage, '-f', 'modules/Dockerfile', '.']
  workingDir goDir
  inputs.file 'Dockerfile'
  inputs.files fileTree(dir: goDir, include: '**/*.go')

  def crumb = file("${buildDir}/docker-built")
  outputs.file crumb
  doLast {
    crumb.text = ''
  }
}

task buildDev(type: Exec, dependsOn: ':go:common:protoc') {
  executable 'docker'
  args = ['build', '-t', goDevImage,
    '--target', 'dev',
    '-f', 'modules/Dockerfile',
    '.',
  ]
  workingDir goDir
  inputs.file 'Dockerfile'
  inputs.files fileTree(dir: goDir, include: '**/*.go')

  def crumb = file("${buildDir}/docker-dev-built")
  outputs.file crumb
  doLast {
    crumb.text = ''
  }
}

task test(type: Exec, dependsOn: buildDev) {
  def cacheDir = "${buildDir}/cache"
  executable 'docker'
  args = [
    'run', '--rm', '-t', 
    goDevImage,
    'go', 'test', 
    '-race', '-cover', '-v', './...',
  ]
  inputs.file 'Dockerfile'
}
